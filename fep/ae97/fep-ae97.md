---
slug: "ae97"
authors: silverpill <@silverpill@mitra.social>
type: implementation
status: DRAFT
dateReceived: 2023-08-14
trackingIssue: https://codeberg.org/fediverse/fep/issues/148
discussionsTo: https://codeberg.org/silverpill/feps
---
# FEP-ae97: Client-side activity signing

## Summary

Existing Fediverse servers manage signing keys on behalf of their users. This proposal describes a new kind of [ActivityPub][ActivityPub] client that lets users sign activities with their own keys, and a server that can distribute client-signed activities to other servers.

## History

[Initial version](https://codeberg.org/fediverse/fep/src/commit/fc9c65daca267be9f91761ed854eac9e829222a2/fep/ae97/fep-ae97.md) of this proposal relied on linking of cryptographic identities to actor objects via [FEP-c390] identity proofs. That mechanism was superseded by [FEP-ef61] which achieves full data portability.

## Requirements

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in [RFC-2119][RFC-2119].

## Discovery

A server that supports clients capable of managing signing keys MUST have a discovery endpoint at the path `/.well-known/apgateway`.

When the server receives an HTTP GET request to this endpoint, it MUST respond with a JSON object containing information about itself. That object MAY be empty.

Example:

```json
{
  "uploadMedia": "https://gateway.example/.well-known/apgateway-media"
}
```

## Registering an actor

Client creates portable actor objects according to [FEP-ef61] and stores them. When a portable actor is created, the client MUST create a key for signing requests (the main actor key) and add a `Multikey` representation of it to the `assertionMethod` array as described in [FEP-521a]. The identifier of that key MUST NOT be a [compatible identifier][CompatibleIdentifiers].

Before registering a portable actor on the server, the client MUST add the server URL to the `gateways` array of the actor object.

To register the actor, the client sends an HTTP POST request to the gateway endpoint at `/.well-known/apgateway` path. The body of the request MUST be an actor object.

The server SHOULD limit registrations (for example, by requiring an invite code). If the server accepts the registration request, it generates an RSA key and returns it in a response. The response MUST have the `201 Created` status code. The body of the response is a JSON object with an `assertionMethod` property. The value of this property is an array containing the RSA public key generated by the server in the [Multikey][CI-Multikey] format.

Example:

```json
{
  "assertionMethod": [
    {
      "type": "Multikey",
      "publicKeyMultibase": "z4MXj1wBzi9jUstyPMS4jQqB6KdJaiatPkAtVtGc6bQEQEEsKTic4G7Rou3iBf9vPmT5dbkm9qsZsuVNjq8HCuW1w24nhBFGkRE4cd2Uf2tfrB3N7h4mnyPp1BF3ZttHTYv3DLUPi1zMdkULiow3M1GfXkoC6DoxDUm1jmN6GBj22SjVsr6dxezRVQc7aj9TxE7JLbMH1wh5X3kA58H3DFW8rnYMakFGbca5CB2Jf6CnGQZmL7o5uJAdTwXfy2iiiyPxXEGerMhHwhjTA1mKYobyk2CpeEcmvynADfNZ5MBvcCS7m3XkFCMNUYBS9NQ3fze6vMSUPsNa6GVYmKx2x6JrdEjCk3qRMMmyjnjCMfR4pXbRMZa3i"
    }
  ]
}
```

If the server can't register the actor, it MUST return a `400 Bad Request` status code.

If the registration is successful, the client MUST attach the RSA key to the actor object via `publicKey` property, and also add it to the `assertionMethod` array as described in [FEP-521a]. If the server's response contains other keys, they SHOULD be added to the `assertionMethod` array as well.

If the client uses [compatible identifiers][CompatibleIdentifiers], then key identifiers MUST be generated with the server's [origin][Origin].

After updating the actor object, the client MUST publish an `Update` activity for it.

## Sending activities

The client submits signed [FEP-ef61] activities to actor's outbox. Contrary to what ActivityPub specification prescribes in section [6. Client to Server Interactions](https://www.w3.org/TR/activitypub/#client-to-server-interactions), the server MUST NOT overwrite the ID of an activity. Instead of assigning a new ID, the server MUST verify that provided ID has not been used before. If the server accepts activity, its response MUST have `202 Accepted` status code.

If activity contains a wrapped object (as in `Create` and `Update` activities), it MUST be a portable object created according to [FEP-ef61]. The server MUST validate object IDs in the same way it validates activity IDs.

The server MUST deliver activities to their indended audiences without altering them. When signing HTTP requests, the server uses the RSA key generated during the registration.

If the owner of the outbox is not registered, the server MUST return a `404 Not Found` status code.

If the actor of the submitted activity is different from the outbox owner, the server MUST return a `403 Forbidden` status code.

## Receiving activities

Client receives activities by polling the actor's inbox.

Requests to inbox endpoint MUST have an [HTTP signature][HttpSig] created using the main actor key (the one generated by the client, not a server-generated key).

If the signature is not valid, the server MUST return a `401 Unauthorized` status code.

If the owner of the inbox is not registered, the server MUST return a `404 Not Found` status code.

If the actor that generated the signature is different from the inbox owner, the server MUST return a `403 Forbidden` status code.

## Media API

### Upload media

To upload a media file, the client sends an HTTP POST request to the gateway endpoint at the `/.well-known/apgateway-media` path. The body of the request MUST be the media in the form of binary data. The request MUST contain a `Content-Type` header and MUST be signed with the main key of the actor.

If the media is processed successfully, the server MUST return a response with a `201 Created` status code and a JSON object as the body. This JSON object MUST have a `url` property whose value is a [hashlink][Hashlinks] to the processed media file.

Example:

```json
{
  "type": "Document",
  "url": "hl:zQmWvQxTqbG2Z9HPJgG57jjwR154cKhbtJenbyYTWkjgF3e"
}
```

The server MUST serve the processed media file at a `/.well-known/apgateway-media/{hashlink}` path.

If the signature is not valid, the server MUST return a `401 Unauthorized` status code. If the signature is valid, but the actor is not registered, the server MUST return a `403 Forbidden` status code.

If the media type is not supported, the server MUST return a `400 Bad Request` status code.

If the media is too large, the server MUST return a `413 Payload Too Large` status code.

### Delete media

To delete a previously uploaded media file, the client sends an HTTP DELETE request to an endpoint at path `/.well-known/apgateway-media/{hashlink}`. The request MUST be signed with the main key of the actor.

If the signature is valid and the actor owns the media file, the server MUST delete the file.

If the signature is not valid, the server MUST return a `401 Unauthorized` status code. If the signature is valid, but the actor is not registered, the server MUST return a `403 Forbidden` status code.

If the media file doesn't exist or not owned by the actor, the server MUST return a `404 Not Found` status code.

## Security considerations

If the server accepts portable objects with [compatible identifiers][CompatibleIdentifiers], it MUST ensure that all objects served by the gateway are valid and that registered actors are sufficiently isolated from each other. Specifically, the server MUST verify that actors and activities generated by the client are permitted in the [origin-based security model][FEP-fe34]:

- Objects MUST NOT represent any actions that actors are not authorized to perform.
- Objects MUST NOT represent server-controlled public keys or verification methods. Such objects can be identifed using the algorithm from [FEP-2277].

Precautions need also be taken when objects with compatible IDs are delivered to inboxes or fetched from remote servers.

## Implementations

- [fep-ae97-client](https://codeberg.org/silverpill/fep-ae97-client) (client)
- Mitra (server)

## References

- Christine Lemmer-Webber, Jessica Tallon, Erin Shepherd, Amy Guy, Evan Prodromou, [ActivityPub], 2018
- S. Bradner, [Key words for use in RFCs to Indicate Requirement Levels][RFC-2119], 1997
- silverpill, [FEP-c390: Identity Proofs][FEP-c390], 2022
- silverpill, [FEP-ef61: Portable Objects][FEP-ef61], 2023
- silverpill, [FEP-521a: Representing actor's public keys][FEP-521a], 2023
- silverpill, [FEP-fe34: Origin-based security model][FEP-fe34], 2024
- silverpill, [FEP-2277: ActivityPub core types][FEP-2277], 2025
- Dave Longley, Manu Sporny, Markus Sabadello, Drummond Reed, Orie Steele, Christopher Allen, [Controlled Identifiers v1.0][ControlledIdentifiers], 2025
- Ryan Barrett, nightpool, [ActivityPub and HTTP Signatures][HttpSig], 2024
- M. Sporny, L. Rosenthol, [Cryptographic Hyperlinks][Hashlinks], 2021

[ActivityPub]: https://www.w3.org/TR/activitypub/
[RFC-2119]: https://tools.ietf.org/html/rfc2119.html
[FEP-c390]: https://codeberg.org/fediverse/fep/src/branch/main/fep/c390/fep-c390.md
[FEP-ef61]: https://codeberg.org/fediverse/fep/src/branch/main/fep/ef61/fep-ef61.md
[CompatibleIdentifiers]: https://codeberg.org/fediverse/fep/src/branch/main/fep/ef61/fep-ef61.md#identifiers-1
[FEP-521a]: https://codeberg.org/fediverse/fep/src/branch/main/fep/521a/fep-521a.md
[FEP-fe34]: https://codeberg.org/fediverse/fep/src/branch/main/fep/fe34/fep-fe34.md
[Origin]: https://codeberg.org/fediverse/fep/src/branch/main/fep/fe34/fep-fe34.md#origin
[FEP-2277]: https://codeberg.org/fediverse/fep/src/branch/main/fep/2277/fep-2277.md
[ControlledIdentifiers]: https://www.w3.org/TR/cid/
[CI-Multikey]: https://www.w3.org/TR/cid/#Multikey
[HttpSig]: https://swicg.github.io/activitypub-http-signature/
[Hashlinks]: https://datatracker.ietf.org/doc/html/draft-sporny-hashlink-07

## Copyright

CC0 1.0 Universal (CC0 1.0) Public Domain Dedication

To the extent possible under law, the authors of this Fediverse Enhancement Proposal have waived all copyright and related or neighboring rights to this work.
